<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>å…­å¹´ç´šå°ˆå±¬ æ¯æ—¥ä»»å‹™å„€è¡¨æ¿</title>
    <style>
        :root {
            --primary: #8d6e63; --success: #6b8e23; --bg: #f5f5dc;
            --card: #ffffff; --text: #4e342e; --border: #d7ccc8; --danger: #d84315;
        }
        body { font-family: "PingFang TC", "Microsoft JhengHei", sans-serif; background: var(--bg); margin: 0; padding: 20px; color: var(--text); display: flex; flex-direction: column; align-items: center; }
        .setup-panel { background: #e9e5d3; padding: 15px; border-radius: 12px; margin-bottom: 20px; display: flex; gap: 10px; align-items: center; border: 1px solid var(--border); width: 100%; max-width: 900px; font-size: 14px; justify-content: center; flex-wrap: wrap; }
        .main-card { background: var(--card); padding: 30px; border-radius: 20px; box-shadow: 0 8px 20px rgba(0,0,0,0.05); width: 100%; max-width: 900px; box-sizing: border-box; }
        
        .timer-zone { background: #fdfaf0; border: 2px solid var(--primary); padding: 8px 20px; border-radius: 50px; display: inline-flex; align-items: center; gap: 10px; margin-bottom: 20px; font-weight: bold; }
        .is-locked { opacity: 0.4; pointer-events: none; filter: grayscale(1); } 
        
        .tabs { display: flex; gap: 10px; margin-bottom: 25px; overflow-x: auto; padding-bottom: 10px; }
        .tab-btn { padding: 10px 20px; border: 2px solid var(--border); border-radius: 50px; background: white; cursor: pointer; color: var(--primary); font-weight: 600; white-space: nowrap; transition: 0.3s; }
        .tab-btn.active { background: var(--primary); color: white; border-color: var(--primary); }
        
        .grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(80px, 1fr)); gap: 12px; transition: 0.5s; }
        .student-btn { aspect-ratio: 1/1; border: 2px solid var(--border); background: white; border-radius: 15px; cursor: pointer; font-size: 26px; font-weight: bold; color: var(--text); position: relative; display: flex; align-items: center; justify-content: center; }
        .student-btn.completed { background: var(--success); color: white; border-color: transparent; }
        
        .info-bar { margin-top: 30px; display: flex; justify-content: space-between; align-items: center; background: #fafaf5; padding: 15px 25px; border-radius: 12px; border: 1px solid #eee; }
        input, select { padding: 6px; border-radius: 6px; border: 1px solid var(--border); }
        .btn-action { background: var(--primary); color: white; border: none; padding: 6px 12px; border-radius: 6px; cursor: pointer; }

        /* ğŸŒŸ å½ˆå‡ºé¼“å‹µè¨Šæ¯çš„æ¨£å¼ ğŸŒŸ */
        #toast {
            visibility: hidden;
            min-width: 250px;
            background-color: var(--success);
            color: #fff;
            text-align: center;
            border-radius: 50px;
            padding: 12px 24px;
            position: fixed;
            z-index: 1000;
            bottom: 30px;
            left: 50%;
            transform: translateX(-50%);
            font-size: 20px;
            font-weight: bold;
            box-shadow: 0 4px 15px rgba(0,0,0,0.2);
            opacity: 0;
            transition: opacity 0.4s, bottom 0.4s;
        }
        #toast.show { visibility: visible; opacity: 1; bottom: 50px; }
        #toast.celebrate { background-color: #ff9800; font-size: 26px; padding: 20px 40px; border: 3px solid #fff; }
    </style>
</head>
<body>

<div class="header"><h1>ğŸ‘‘ æ¯æ—¥ä»»å‹™å„€è¡¨æ¿</h1></div>

<div class="setup-panel">
    <span>å…¨ç­äººæ•¸ï¼š<input type="number" id="numInput" value="32" style="width: 45px;"></span>
    <span>æ–°å¢æ¿å¡Šï¼š<input type="text" id="tabInput" placeholder="å¦‚ï¼šå›æ¢" style="width: 80px;"></span>
    <button class="btn-action" onclick="addNewCategory()">æ–°å¢</button>
    <div style="border-left: 1px solid #ccc; height: 20px; margin: 0 10px;"></div>
    <span>ã€Œ<span id="settingTabName">ç•¶å‰æ¿å¡Š</span>ã€æˆªæ­¢ï¼š
        <input type="time" id="deadlineInput" onchange="updateTabDeadline()">
        <label style="cursor: pointer; font-weight: bold; margin-left: 5px;">
            <input type="checkbox" id="noLimitCheck" onchange="toggleNoLimit()"> ä¸é™æ™‚
        </label>
    </span>
</div>

<div class="main-card">
    <div style="text-align: center;">
        <div class="timer-zone">
            ğŸ•’ <span id="currentTime">00:00:00</span>
            <span id="statusLabel" style="margin-left: 10px; padding: 2px 10px; border-radius: 10px; font-size: 14px;"></span>
            <span id="deadlineText" style="font-size: 14px; color: var(--primary);"></span>
        </div>
    </div>

    <div class="tabs" id="tabs"></div>
    <div class="grid" id="grid"></div>

    <div class="info-bar">
        <span>å·²å®Œæˆï¼š<strong id="statCount" style="color: var(--success); font-size: 28px;">0</strong> / <span id="statTotal">32</span></span>
        <button onclick="clearCurrent()" style="color: var(--danger); background: none; border: none; cursor: pointer; font-size: 14px;">æ¸…ç©ºæœ¬é ç´€éŒ„</button>
    </div>
</div>

<div id="toast">é€™è£¡æœƒé¡¯ç¤ºé¼“å‹µçš„è©±ï¼</div>

<script>
    // ğŸ’¡ è€å¸«å¯ä»¥éš¨æ™‚åœ¨é€™è£¡ä¿®æ”¹æˆ–å¢åŠ ä½ è¦èªªçš„è©±ï¼
    const individualMsgs = [
        "ä½ ä»Šå¤©ä¹Ÿå¾ˆæ£’å–”ï¼ğŸŒŸ",
        "å¤ªå„ªç§€äº†ï¼ç¹¼çºŒä¿æŒï¼ğŸ‘",
        "ä»»å‹™é”æˆï¼çµ¦ä½ ä¸€å€‹è®šï¼âœ¨",
        "å¥½è®šï¼è€å¸«æœ‰çœ‹åˆ°ä½ çš„åŠªåŠ›ï¼ğŸ‘€",
        "å‹•ä½œçœŸå¿«ï¼å¤ªç¥å•¦ï¼âš¡",
        "å¾ˆæ£’ï¼å¯ä»¥å®‰å¿ƒå»ä¼‘æ¯å›‰ï¼ğŸˆ"
    ];

    const classMsgs = [
        "ğŸ‰ ç‹‚è³€ï¼å…¨ç­éƒ½å®Œæˆå•¦ï¼å…­å¹´ç´šæœ€æ£’ï¼ ğŸ‰",
        "ğŸ† å¤ªç¥äº†ï¼å¤§å®¶ä¸€èµ·é”æˆç›®æ¨™ï¼Œè€å¸«è¦ºå¾—é©•å‚²ï¼ ğŸ†",
        "âœ¨ å®Œç¾çš„åœ˜éšŠåˆä½œï¼çµ¦å…¨ç­æ‹æ‹æ‰‹ï¼ âœ¨"
    ];

    let config = JSON.parse(localStorage.getItem('classConfig_v6')) || {
        studentCount: 32,
        categories: [
            { name: 'ä½œæ¥­è¨‚æ­£', deadline: '' },
            { name: 'ä¸­åˆæ½”ç‰™', deadline: '12:35' },
            { name: 'æ¡Œé¢æ•´æ½”', deadline: '12:40' }
        ]
    };
    let data = JSON.parse(localStorage.getItem('classData_v6')) || {};
    let currentTabName = config.categories[0].name;

    // é¡¯ç¤ºé¼“å‹µè¨Šæ¯çš„å‡½æ•¸
    function showToast(msg, isCelebrate = false) {
        const toast = document.getElementById("toast");
        toast.innerText = msg;
        if (isCelebrate) toast.classList.add("celebrate");
        else toast.classList.remove("celebrate");
        
        toast.classList.add("show");
        setTimeout(() => { toast.classList.remove("show"); }, 3000); // 3ç§’å¾Œæ¶ˆå¤±
    }

    function init() {
        document.getElementById('numInput').value = config.studentCount;
        document.getElementById('numInput').onchange = (e) => { config.studentCount = e.target.value; saveAll(); renderGrid(); };
        renderTabs();
        renderGrid();
        setInterval(refreshUI, 1000);
    }

    function renderTabs() {
        const container = document.getElementById('tabs');
        container.innerHTML = '';
        config.categories.forEach(cat => {
            const btn = document.createElement('button');
            btn.className = `tab-btn ${cat.name === currentTabName ? 'active' : ''}`;
            btn.innerText = cat.name;
            btn.onclick = () => { currentTabName = cat.name; renderTabs(); renderGrid(); };
            container.appendChild(btn);
        });

        const currentCat = config.categories.find(c => c.name === currentTabName);
        document.getElementById('settingTabName').innerText = currentTabName;
        const isNoLimit = (currentCat.deadline === '');
        document.getElementById('noLimitCheck').checked = isNoLimit;
        document.getElementById('deadlineInput').disabled = isNoLimit;
        
        if (isNoLimit) {
            document.getElementById('deadlineInput').value = '';
            document.getElementById('deadlineText').innerText = '(ä¸é™æ™‚)';
        } else {
            document.getElementById('deadlineInput').value = currentCat.deadline;
            document.getElementById('deadlineText').innerText = `(æˆªæ­¢ï¼š${currentCat.deadline})`;
        }
    }

    function renderGrid() {
        const grid = document.getElementById('grid');
        grid.innerHTML = '';
        const count = parseInt(config.studentCount);
        document.getElementById('statTotal').innerText = count;
        if (!data[currentTabName]) data[currentTabName] = [];
        let completed = 0;
        
        for (let i = 1; i <= count; i++) {
            const btn = document.createElement('button');
            btn.className = `student-btn ${data[currentTabName].includes(i) ? 'completed' : ''}`;
            btn.innerText = i;
            if (data[currentTabName].includes(i)) completed++;
            
            btn.onclick = () => {
                const index = data[currentTabName].indexOf(i);
                let isChecking = false;
                
                if (index === -1) {
                    data[currentTabName].push(i);
                    isChecking = true; // ä»£è¡¨é€™æ¬¡é»æ“Šæ˜¯ã€Œå®Œæˆä»»å‹™ã€
                } else {
                    data[currentTabName].splice(index, 1); // å–æ¶ˆæ‰“å‹¾
                }
                saveAll(); 
                renderGrid();

                // ğŸŒŸ è§¸ç™¼é¼“å‹µè¨Šæ¯çš„é‚è¼¯ ğŸŒŸ
                if (isChecking) {
                    if (data[currentTabName].length === count) {
                        // å…¨ç­å®Œæˆ
                        const randomClassMsg = classMsgs[Math.floor(Math.random() * classMsgs.length)];
                        showToast(randomClassMsg, true);
                    } else {
                        // å€‹äººå®Œæˆ
                        const randomIndMsg = individualMsgs[Math.floor(Math.random() * individualMsgs.length)];
                        showToast(`${i}è™ŸåŒå­¸ï¼Œ${randomIndMsg}`);
                    }
                }
            };
            grid.appendChild(btn);
        }
        document.getElementById('statCount').innerText = completed;
        refreshUI();
    }

    function refreshUI() {
        const now = new Date();
        document.getElementById('currentTime').innerText = now.toTimeString().split(' ')[0];
        const currentCat = config.categories.find(c => c.name === currentTabName);
        const grid = document.getElementById('grid');
        const label = document.getElementById('statusLabel');
        
        if (currentCat.deadline === '') {
            grid.classList.remove('is-locked');
            label.innerText = "ä¸é™æ™‚é–‹æ”¾";
            label.style.background = "#e3f2fd"; label.style.color = "#1565c0";
        } else {
            const [h, m] = currentCat.deadline.split(':');
            const deadlineDate = new Date();
            deadlineDate.setHours(h, m, 0);
            if (now > deadlineDate) {
                grid.classList.add('is-locked');
                label.innerText = "å·²æˆªæ­¢";
                label.style.background = "#ffcdd2"; label.style.color = "#c62828";
            } else {
                grid.classList.remove('is-locked');
                label.innerText = "é–‹æ”¾ä¸­";
                label.style.background = "#c8e6c9"; label.style.color = "#2e7d32";
            }
        }
    }

    function toggleNoLimit() {
        const isChecked = document.getElementById('noLimitCheck').checked;
        const currentCat = config.categories.find(c => c.name === currentTabName);
        if (isChecked) currentCat.deadline = '';
        else currentCat.deadline = '16:00'; 
        saveAll(); renderTabs(); refreshUI();
    }

    function updateTabDeadline() {
        if (document.getElementById('noLimitCheck').checked) return;
        const currentCat = config.categories.find(c => c.name === currentTabName);
        currentCat.deadline = document.getElementById('deadlineInput').value;
        saveAll(); renderTabs(); refreshUI();
    }

    function addNewCategory() {
        const name = document.getElementById('tabInput').value.trim();
        if (name && !config.categories.find(c => c.name === name)) {
            config.categories.push({ name: name, deadline: '' });
            saveAll(); document.getElementById('tabInput').value = ''; renderTabs();
        }
    }

    function clearCurrent() {
        if (confirm(`ç¢ºå®šæ¸…ç©ºã€Œ${currentTabName}ã€ä»Šæ—¥ç´€éŒ„ï¼Ÿ`)) {
            data[currentTabName] = []; saveAll(); renderGrid();
        }
    }

    function saveAll() {
        localStorage.setItem('classConfig_v6', JSON.stringify(config));
        localStorage.setItem('classData_v6', JSON.stringify(data));
    }

    init();
</script>
</body>
</html>
